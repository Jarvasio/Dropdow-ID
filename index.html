<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Dropdown Dinâmico (via formID)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
      color: #333;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    select {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    select:focus {
      outline: none;
      border-color: #3966fa;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }
  </style>
</head>
<body>

  <label for="dropdown">Selecione:</label>
  <select id="dropdown">
    <option selected disabled>A carregar opções...</option>
  </select>

  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  <script>
    let formID = "";
    const apiKey = "9be9a89e6af80cf2e4a4891b2170dd0b";
    const dropdown = document.getElementById("dropdown");

    JFCustomWidget.subscribe("ready", async () => {
      const settings = JFCustomWidget.getWidgetSettings();
      formID = (settings?.id || "").trim();

      if (!formID) {
        alert("O parâmetro 'id' (formID) não foi fornecido.");
        console.error("Parâmetro 'id' ausente ou vazio.");
        return;
      }

      console.log("Formulário de origem definido como:", formID);
      await carregarSubmissoes(formID);
    });

    async function carregarSubmissoes(formID) {
      const url = `https://eu-api.jotform.com/form/${formID}/submissions?apiKey=${apiKey}&limit=1000`;

      console.log("A consultar a API Jotform com URL:", url);

     try {
            const res = await fetch(url);
            const data = await res.json();
          
            console.log("Resposta completa da API:", data);
          
            if (!data || !Array.isArray(data.content)) {
              console.error("Conteúdo da API inválido ou vazio:", data.content);
              throw new Error("Formato inesperado: 'content' não é array.");
        }
       try {
              const res = await fetch(url);
              const data = await res.json();
            
              console.log("Resposta crua da API:", data);
              console.log("Tipo de content:", typeof data.content);
              console.log("É array?", Array.isArray(data.content));
              console.log("Content:", data.content);
            
              if (!data || !Array.isArray(data.content)) {
                throw new Error("Formato inesperado: 'content' não é array.");
          }

  // ... (continua como antes)

        const opcoesUnicas = new Set();
        dropdown.innerHTML = '<option disabled selected>Escolha uma opção...</option>';

        data.content.forEach(submissao => {
          const campo1 = submissao.answers?.["1"]?.answer;
          const campo2 = submissao.answers?.["2"]?.answer;

          const texto = [campo1, campo2].filter(Boolean).join(" / ").trim();

          if (texto && !opcoesUnicas.has(texto)) {
            opcoesUnicas.add(texto);
            dropdown.appendChild(new Option(texto, texto));
          }
        });

        if (opcoesUnicas.size === 0) {
          dropdown.innerHTML = '<option disabled selected>Sem dados disponíveis</option>';
        }

      } catch (erro) {
        console.error("Erro ao consultar a API:", erro);
        dropdown.innerHTML = '<option disabled selected>Erro ao carregar dados</option>';
        alert("Erro ao carregar dados do formulário alvo. Verifica o formID e a API Key.");
      }
    }

    dropdown.addEventListener("change", () => {
      const valorSelecionado = dropdown.value;
      console.log("Selecionado:", valorSelecionado);

      JFCustomWidget.send({
        valid: true,
        value: valorSelecionado
      });

      console.log("Valor enviado com sucesso");
    });
  </script>
</body>
</html>
